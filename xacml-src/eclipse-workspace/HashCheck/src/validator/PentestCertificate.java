package validator;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.text.ParseException;
import java.util.Date;

import org.opensaml.DefaultBootstrap;
import org.opensaml.saml2.core.Assertion;
import org.opensaml.saml2.core.Attribute;
import org.opensaml.saml2.core.AttributeStatement;
import org.opensaml.xml.Configuration;
import org.opensaml.xml.ConfigurationException;
import org.opensaml.xml.XMLObject;
import org.opensaml.xml.io.Unmarshaller;
import org.opensaml.xml.io.UnmarshallerFactory;
import org.opensaml.xml.io.UnmarshallingException;
import org.opensaml.xml.parse.BasicParserPool;
import org.opensaml.xml.parse.XMLParserException;
import org.w3c.dom.Document;
import org.w3c.dom.Element;

import core.Utils;
import xacml.SignatureHelper;
import xacml.PropTypes;
import xacml.Property;

public class PentestCertificate extends CTICertificate {
	private String testerName;
	private String organization;
	private String email;
	private String website;
	
	public static void main(String[] args) throws FileNotFoundException, NullPointerException, ParseException {
		String url = "https://ctidev4.critical.com/certs/samplePentesterCert.xml";
		PentestCertificate sable;
		
		try{
//			sable = new CTICertificate(new File("c:\\users\\advan\\desktop\\withid.xml"));
			sable = new PentestCertificate(new URL(url));
		}catch (Exception e){
			e.printStackTrace();
			sable = null;
		}

		
		if(sable != null){
			System.out.println("This certificate is issued by: " + sable.getIssuerName());
			System.out.println("Effective on: " + sable.getValidityNotBefore());
			System.out.println("Expires on: " + sable.getValidityNotAfter());
			System.out.println("Signatured validated: " + sable.getValidSig());
			System.out.println("Digest validated: " + sable.getValidDigest());
			System.out.println("Cert hash: " + sable.getHashOfCert());
			System.out.println("Properties: " + sable.getSubjectProperties());
			System.out.println("Tester name: " + sable.getTesterName());
			System.out.println("Organization: " + sable.getOrganization());
			System.out.println("Website: " + sable.getWebsite());
			System.out.println("Email: " + sable.getEmail());
			
			
			

		}else{
			System.out.println("There is some problem with your certificate!");
		}


	}
	
	public PentestCertificate(String cert) throws ParseException, NullPointerException, IOException, XMLParserException, UnmarshallingException, ConfigurationException, BadDigestException, NoSuchAlgorithmException  {
        parseCertificate(cert);
		validate();
	}
	
	public PentestCertificate(File fd) throws ParseException, NullPointerException, IOException, XMLParserException, UnmarshallingException, ConfigurationException, BadDigestException, NoSuchAlgorithmException  {
        parseCertificate(Utils.readFile(fd));
		validate();
	}
	
	public PentestCertificate(URL website) throws ParseException, NullPointerException, IOException, XMLParserException, UnmarshallingException, ConfigurationException, BadDigestException, NoSuchAlgorithmException  {
		parseCertificate(Utils.getTextFromUrl(website));
		validate();
	}

	private void parseCertificate(String cert) throws ConfigurationException, XMLParserException, UnmarshallingException, ParseException, BadDigestException, NoSuchAlgorithmException{
		fullCertificate = cert;
		validDigest = new validateDigest().validDigest(fullCertificate);
		if(!validDigest)
			throw new BadDigestException("Bad digest!");
			
		
		setHashOfCert(Utils.byteArrayToHex(MessageDigest.getInstance("SHA-256").digest(cert.getBytes(StandardCharsets.UTF_8))));
		
	     // Initialize the library
        DefaultBootstrap.bootstrap(); 
         
        // Get parser pool manager
        BasicParserPool ppMgr = new BasicParserPool();
        ppMgr.setNamespaceAware(true);
         
        // Parse metadata file
        Document inCommonMDDoc = ppMgr.parse(new ByteArrayInputStream(fullCertificate.getBytes(StandardCharsets.UTF_8)));
        Element metadataRoot = inCommonMDDoc.getDocumentElement();
         
        // Get apropriate unmarshaller
        UnmarshallerFactory unmarshallerFactory = Configuration.getUnmarshallerFactory();
        Unmarshaller unmarshaller = unmarshallerFactory.getUnmarshaller(metadataRoot);
        
        Assertion ass = (Assertion) unmarshaller.unmarshall(metadataRoot);
        setId(ass.getID());
        
        setIssuerName(ass.getIssuer().getValue());
        setValidityNotBefore(ass.getConditions().getNotBefore().toDate());
        setValidityNotOnOrAfter(ass.getConditions().getNotOnOrAfter().toDate());
        
        setSubjectHashInfoHash(ass.getSubject().getNameID().getValue());
        setSubjectHashInfoAlgo(ass.getSubject().getNameID().getNameQualifier());

        
        AttributeStatement as = ass.getAttributeStatements().get(0);
        for(Attribute att : as.getAttributes()){
        	if(att.getName().equals("pentest-info")){
        		XMLObject attVal = att.getAttributeValues().get(0);
        		for(XMLObject xmo : attVal.getOrderedChildren()){
        			if(xmo.getDOM().getNodeName().toLowerCase().equals("name")){
        				setSubjectName(xmo.getDOM().getTextContent());
        			}else if(xmo.getDOM().getNodeName().toLowerCase().equals("description")){
        				setSubjectDescription(xmo.getDOM().getTextContent());
        			}else if (xmo.getDOM().getNodeName().toLowerCase().equals("length")){
        				int length = Integer.parseInt(xmo.getDOM().getTextContent());
        				setSubjectLength(length);
        			}else if(xmo.getDOM().getNodeName().toLowerCase().equals("version")){
        				setSubjectVersion(xmo.getDOM().getTextContent());
        			}else if(xmo.getDOM().getNodeName().toLowerCase().equals("properties")){
        				for(XMLObject entry : xmo.getOrderedChildren()){
        					Property p = new Property();
    						p.type = PropTypes.PROOF;
        					
        					for(XMLObject elem : entry.getOrderedChildren()){
	        					if(elem.getDOM().getNodeName().toLowerCase().equals("name")){
	        						p.propertyName = elem.getDOM().getTextContent();
	        					}else if(elem.getDOM().getNodeName().toLowerCase().equals("description")){
	        						p.propertyValue = elem.getDOM().getTextContent();
	        					}
        					}
        					setSubjectProperty(p);
        				}
        			}else if(xmo.getDOM().getNodeName().equals("pentester")){
        				for(XMLObject xmo2 : xmo.getOrderedChildren()){
        					if(xmo2.getDOM().getNodeName().equals("name")){
        						setTesterName(xmo2.getDOM().getTextContent());
        					}else if(xmo2.getDOM().getNodeName().equals("organization")){
        						setOrganizationName(xmo2.getDOM().getTextContent());
        					}else if(xmo2.getDOM().getNodeName().equals("email")){
        						setEmail(xmo2.getDOM().getTextContent());
        					}else if(xmo2.getDOM().getNodeName().equals("website")){
        						setWebsite(xmo2.getDOM().getTextContent());
        					}
    					}
        			}
        		}
        	}
        }
	}
	
	@Override
	public boolean equals(Object obj) {
	    if (obj == null) {
	        return false;
	    }
	    if (!PentestCertificate.class.isAssignableFrom(obj.getClass())) {
	        return false;
	    }
	    final PentestCertificate other = (PentestCertificate) obj;
	    if ((this.hashOfCert == null) ? (other.hashOfCert != null) : !this.hashOfCert.equals(other.hashOfCert)) {
	        return false;
	    }
	    return true;
	}
	
	private void validate(){
		// Date validation
		Date d = new Date();
		if(!(d.before(ValidityNotBefore) || d.after(ValidityNotAfter))){
			validDate = true;
		}
		
		// Signature validation
		if(fullCertificate != null){
			validSig = new SignatureHelper().verifyAssertionSignature(fullCertificate);
		}
		
		if(!SubjectProperties.isEmpty()){
			validProps = true;
		}
		
	}
	
	public String getTesterName() {return testerName;}
	public String getOrganization() {return organization;}
	public String getWebsite() {return website;}
	public String getEmail() {return email;}

	public void setTesterName(String testerName) {
		this.testerName = testerName;
	}
	
	public void setOrganizationName(String organization) {
		this.organization = organization;
	}

	public void setWebsite(String website) {
		this.website = website;
	}
	
	public void setEmail(String email) {
		this.email = email;
	}
	
}
